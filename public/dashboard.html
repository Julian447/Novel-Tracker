<!DOCTYPE html>
<html>
<head>
  <title>Syosetu Tracker</title>
</head>
<body>

  <div id="dashboardContent" style="display:none;">
    <h1>Dashboard</h1>
    <button id="logoutBtn">Logout</button>
    <button onclick="window.location.href='/login'">Go to Login</button>
    <button onclick="window.location.href='/lookup'">Go to Novel Lookup</button>
    <button onclick="window.location.href='/tracker'">Go to Tracker</button>
    <h2>Users</h2>
    <ul id="userList"></ul>
    <h2>Tracked Novels</h2>
    <ul id="trackedNovelList"></ul>
    <h2>All Novels</h2>
    <ul id="novelList"></ul>

  <script src="/auth.js"></script>
  <script>
    requireAuth('dashboardContent');
    function loadUsers() {
      fetch('/api/users', {
        headers: {
          'Authorization': 'Bearer ' + localStorage.getItem('token')
        }
      })
      .then(res => {
        if (res.status === 401 || res.status === 403) {
          document.getElementById('userList').innerHTML = '<li>Login to see users</li>';
          return [];
        }
        return res.json();
      })
      .then(users => {
        const list = document.getElementById('userList');
        list.innerHTML = '';
        users.forEach(u => {
          const li = document.createElement('li');
          li.textContent = `${u.name} (${u.email})`;
          list.appendChild(li);
        });
      });
    }
    function loadFollows() {
      authFetch('/api/novels/follow', { method: 'GET' })
      .then(res => {
        if (res.status === 401 || res.status === 403) {
          document.getElementById('trackedNovelList').innerHTML = '<li>No tracked novels</li>';
          return [];
        }
        return res.json();
      })
      .then(novels => {
        const list = document.getElementById('trackedNovelList');
        list.innerHTML = '';
        novels.forEach(n => {
          const li = document.createElement('li');
          li.textContent = `Ncode:${n.ncode}, Title: ${n.title}, Author: ${n.author}, Current Chapters: ${n.current_chapter}, Total Chapters: ${n.total_chapters}, Last Checked: ${n.last_checked}, User ID: ${n.user_id}, Followed At: ${n.followed_at}`;
          list.appendChild(li);
        });
      });
    }
    function loadNovels() {
      authFetch('/api/novels')
      .then(res => {
        if (res.status === 401 || res.status === 403) {
          document.getElementById('novelList').innerHTML = '<li>No novels in database</li>';
          return [];
        }
        return res.json();
      })
      .then(novels => {
        const list = document.getElementById('novelList');
        list.innerHTML = '';
        novels.forEach(n => {
          const li = document.createElement('li');
          li.textContent = `Ncode:${n.ncode}, Title: ${n.title}, Author: ${n.author}, Total Chapters: ${n.total_chapters}, Last Checked: ${n.last_checked}`;
          list.appendChild(li);
        });
      });
    }
    loadUsers();
    loadFollows();
    loadNovels();

    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('token');
      alert('Logged out!');
      window.location.href = '/login';
    };
  </script>
</body>
</html>
